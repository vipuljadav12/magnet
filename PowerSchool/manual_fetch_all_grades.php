<?php
set_time_limit(0);
ini_set('memory_limit', '-1');
include('functions.php');
include_once('dbClass.php');
$type = 'student_storedgrades';
$url = 'https://huntsvillecs.powerschool.com';
$clientID = 'c9d982cd-011e-4ed4-991b-bca6540b4988';
$clientSecret = '7888e8d5-86b2-4e5b-afc3-3cd0a482115e';

$objDB = new MySQLCN; 


$accessToken = getAccessToken($url, $clientID, $clientSecret);
$accessTokenArray = json_decode($accessToken);

if (!empty($accessTokenArray)) {
    $accessTokenKey = $accessTokenArray->access_token;
    $accessTokenType = $accessTokenArray->token_type;
    $accessTokenExpiresIn = $accessTokenArray->expires_in;
    
    if (isset($accessTokenKey) && !empty($accessTokenKey)) {
        $SQL = "SELECT id, student_id FROM submissions WHERE id in (6045,6034,6031,6029,6023,6019,6018,6008,6002,5992,5982,5977,5954,5944,5936,5924,5921,5920,5917,5915,5914,5906,5900,5899,5898,5897,5896,5893,5892,5867,5852,5848,5844,5843,5841,5836,5832,5830,5829,5828,5827,5826,5825,5823,5822,5820,5795,5773,5772,5771,5766,5755,5754,5749,5741,5732,5720,5719,5718,5716,5712,5709,5703,5702,5701,5700,5698,5697,5694,5654,5653,5650,5640,5617,5615,5608,5607,5606,5598,5595,5587,5586,5585,5581,5579,5576,5574,5571,5563,5562,5559,5556,5555,5553,5546,5545,5544,5541,5540,5534,5533,5528,5525,5524,5522,5517,5514,5513,5510,5509,5505,5504,5503,5500,5499,5497,5496,5494,5491,5490,5489,5487,5479,5474,5470,5469,5467,5466,5460,5455,5454,5453,5441,5440,5400,5397,5396,5393,5386,5379,5378,5377,5376,5364,5352,5351,5346,5339,5335,5334,5333,5325,5323,5321,5318,5314,5313,5307,5306,5304,5301,5300,5299,5298,5286,5285,5279,5278,5273,5271,5270,5269,5268,5265,5264,5261,5256,5248,5247,5246,5243,5239,5232,5231,5224,5222,5218,5208,5194,5192,5191,5190,5187,5186,5182,5175,5173,5172,5171,5169,5167,5164,5160,5159,5157,5154,5148,5146,5145,5143,5139,5138,5135,5132,5130,5125,5124,5122,5114,5113,5111,5105,5099,5098,5097,5092,5088,5087,5086,5078,5075,5074,5070,5064,5062,5048,5045,5041,5040,5031,5030,5028,5022,5021,5019,5016,5011,5007,5004,5003,5002,5000,4995,4993,4988,4985,4984,4983,4982,4981,4980,4978,4977,4973,4970,4969,4968,4967,4966,4951,4939,4926,4925,4920,4919,4913,4910,4908,4900,4898,4895,4891,4887,4886,4873,4869,4866,4862,4850,4848,4834,6038,5980,5952,5923,5908,5840,5812,5779,5776,5751,5721,5710,5699,5655,5651,5609,5566,5485,5459,5457,5428,5425,5413,5401,5392,5383,5381,5367,5366,5331,5322,5283,5263,5255,5252,5249,5225,5178,5151,5129,5085,5073,5020,5017,5001,4997,4927,6020,5990,5964,5895,5842,5789,5739,5619,5577,5426,5424,5423,5421,5414,5412,5411,5375,5369,5353,5341,5223,5201,5183,5155,5101,5094,5013,5009,4974,4857,4838,4833,5928,5886,5885,5882,5434,5427,5063,4987,4979,4938)";//" LIMIT 1";
        $rs = $objDB->select($SQL);

        if(count($rs) > 0)
        {
            for($i=0; $i < count($rs); $i++)
            {

            $SQL = "SELECT dcid FROM student WHERE stateID = '".$rs[$i]['student_id']."'";
            $rsS = $objDB->select($SQL);

           
                $powerSchoolRecords = getPowerSchoolRecords(
                    $type, 
                    $accessTokenKey, 
                    $url, 
                    array(
                        "submission_id"=>$rs[$i]['id'], 
                        "student_id"=>($rsS[0]['dcid'] ?? ''),
                        "submission" => $rs,
                        "DB"=>$objDB
                    )
                );


          

            
            }

        }
        //}
    }
} else {
    echo "Invalid Token";
}
